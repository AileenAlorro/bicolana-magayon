<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7th Grade Math Quest: Proportionality Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Slate Gray, Sky Blue, White, Emerald Green -->
    <!-- Application Structure Plan: The application is designed as an interactive dashboard. The core structure uses a two-column layout: the left (main) column contains the quiz content, organized into three clear, navigable tabs corresponding to the 'Challenges' in the source report. The right column features a persistent 'Performance Hub' with a dynamic bar chart. This design was chosen to allow users to focus on one topic at a time while always having a clear, visual summary of their progress in view. This is more effective than a linear document because it provides immediate feedback and a synthesized overview of strengths and weaknesses, which is the primary goal of a diagnostic test. -->
    <!-- Visualization & Content Choices: 1. Main Data (Questions): Converted from static text to interactive HTML forms (radio buttons, text inputs). Goal: Assess knowledge. Interaction: User selection/input and a 'Check' button for immediate validation. Justification: This transforms passive reading into active problem-solving, increasing engagement. 2. Performance Summary: A dynamic bar chart. Goal: Synthesize results. Viz Method: Chart.js Bar Chart. Interaction: The chart updates in real-time as each question is answered. Tooltips provide exact scores on hover. Justification: A bar chart offers a very clear and direct comparison of performance across the three distinct categories, making it easy for a student or teacher to instantly identify areas of strength and weakness. CONFIRMED: NO SVG/Mermaid used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        .nav-button[aria-current="true"] {
            background-color: #0284c7;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .correct-answer {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }
        .incorrect-answer {
             outline: 2px solid #f43f5e;
             outline-offset: 2px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #0284c7; /* Sky Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">The Proportionality Quest</h1>
            <p class="mt-2 text-lg text-slate-600">Complete the challenges to reveal your math superpowers!</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <nav id="challenges-nav" class="flex flex-col sm:flex-row gap-2 border-b border-slate-200 pb-4 mb-6">
                </nav>

                <div id="quest-content">
                    <h2 id="challenge-title" class="text-2xl font-bold mb-2 text-sky-700"></h2>
                    <p id="challenge-description" class="text-slate-600 mb-6"></p>
                    <div id="questions-container" class="space-y-8">
                    </div>
                </div>
            </div>

            <aside class="bg-white rounded-2xl shadow-lg p-6 md:p-8 lg:sticky top-8" style="align-self: start;">
                <h2 class="text-2xl font-bold text-center mb-4 text-slate-900">Performance Hub</h2>
                <p class="text-slate-600 text-center mb-4 text-sm">Your score breakdown will appear here as you answer.</p>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div id="summary-text" class="text-center mt-4 text-slate-600 font-semibold"></div>
            </aside>
        </main>
    </div>

    <script>
        const questData = {
            "understanding": {
                title: "Understanding the Balance",
                description: "Figure out which relationships are fair and balanced, and find their secret constant!",
                questions: [
                    { type: 'mcq', text: 'A recipe calls for 2 cups of flour for every 3 cups of sugar. If you use 6 cups of flour, how many cups of sugar do you need?', options: ['4 cups', '6 cups', '9 cups', '12 cups'], answer: 2 },
                    { type: 'mcq', text: 'Which table represents a proportional relationship?', options: [ 'Table A: (1,3), (2,5), (3,7)', 'Table B: (1,2), (2,4), (3,6)', 'Table C: (1,1), (2,4), (3,9)', 'Table D: (1,5), (2,5), (3,5)' ], answer: 1},
                    { type: 'text', text: 'Based on the proportional table from the last question, what is the constant of proportionality (k)?', answer: '2' },
                    { type: 'mcq', text: "A graph of cost (y) vs. weight (x) is a straight line through the origin (0,0). What does this mean?", options: ["It's non-proportional", "It's proportional", "Cost is fixed", "Weight is fixed"], answer: 1},
                    { type: 'text', text: 'A car travels 150 miles in 3 hours. What is its unit rate in miles per hour?', answer: '50' },
                    { type: 'truefalse', text: 'True or False: In a proportional relationship, the ratio y/x is always the same (for x ≠ 0).', answer: 'true' },
                    { type: 'text', text: 'A store sells 5 notebooks for $10.00. What is the constant of proportionality (cost per notebook)?', answer: '2' },
                ]
            },
            "working": {
                title: "Proportional Power Moves",
                description: "Use your proportional thinking to solve real-world puzzles and write powerful equations!",
                questions: [
                    { type: 'text', text: 'If 4 oranges cost $2.00, how much would 10 oranges cost? (Enter number only)', answer: '5' },
                    { type: 'text', text: 'A runner completes 2 laps in 8 minutes. At this rate, how many minutes will it take to complete 5 laps?', answer: '20' },
                    { type: 'mcq', text: "In the equation y = 7x (pages read), what does the '7' represent?", options: ["Total pages", "Total hours", "Pages per hour", "Total books"], answer: 2},
                    { type: 'text', text: 'A store offers 20% off a shirt that originally costs $30.00. What is the discount amount in dollars?', answer: '6' },
                    { type: 'text', text: 'A recipe needs 3 cups of sugar for every 4 cups of flour. If you use 6 cups of flour, how much sugar do you need?', answer: '4.5' },
                    { type: 'text', text: 'On a graph of a proportional relationship, the point (1, 5) is plotted. What is the constant of proportionality?', answer: '5' },
                    { type: 'text', text: 'Write an equation for total cost (y) if x items cost $4.50 each.', answer: 'y=4.5x' },
                ]
            },
            "scaling": {
                title: "Scaling Up & Down",
                description: "Shrink and grow objects proportionally to find real-world measurements!",
                questions: [
                    { type: 'text', text: 'On a map, 1 inch represents 20 miles. If two cities are 3.5 inches apart, what is the actual distance?', answer: '70' },
                    { type: 'text', text: 'A model car has a scale of 1:24. If the model is 7 inches long, what is the actual length of the car in inches?', answer: '168' },
                    { type: 'text', text: 'A 4-inch wide by 6-inch long photo is enlarged to be 12 inches long. What is the new width?', answer: '8' },
                    { type: 'text', text: 'A drawing uses a scale of 1 cm = 2 meters. If a room is 8 meters wide in reality, how wide is it in the drawing (in cm)?', answer: '4' },
                    { type: 'text', text: 'A blueprint uses a scale of 1/4 inch = 1 foot. If a wall is 2 inches long on the blueprint, how long is the actual wall in feet?', answer: '8' },
                    { type: 'truefalse', text: 'True or False: When a figure is scaled up by a factor of 3, its area also increases by a factor of 3.', answer: 'false' },
                ]
            }
        };

        let performanceScores = {
            understanding: { correct: 0, total: questData.understanding.questions.length },
            working: { correct: 0, total: questData.working.questions.length },
            scaling: { correct: 0, total: questData.scaling.questions.length }
        };

        const navContainer = document.getElementById('challenges-nav');
        const contentContainer = document.getElementById('questions-container');
        const challengeTitle = document.getElementById('challenge-title');
        const challengeDescription = document.getElementById('challenge-description');
        let currentChallengeId = 'understanding';
        let performanceChart;

        const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.

        async function callGeminiAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API returned an unexpected structure:", result);
                    return "Sorry, I couldn't generate a response. Please try again.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "An error occurred while connecting to the AI. Please try again later.";
            }
        }

        async function getGeminiHint(questionText, hintEl) {
            hintEl.innerHTML = '<div class="loading-spinner"></div> Generating hint...';
            const prompt = `Provide a short, subtle hint for this 7th grade math problem about proportional relationships without giving away the answer: "${questionText}"`;
            const hint = await callGeminiAPI(prompt);
            hintEl.innerHTML = `<p class="mt-2 p-3 bg-blue-50 rounded-md border border-blue-200 text-blue-800 text-sm">✨ Hint: ${hint}</p>`;
        }

        async function getGeminiExplanation(questionText, correctAnswer, explanationEl) {
            explanationEl.innerHTML = '<div class="loading-spinner"></div> Generating explanation...';
            const prompt = `Explain the concept behind this 7th grade math problem about proportional relationships and its solution in a way a 7th grader can understand: "${questionText}" The correct answer is "${correctAnswer}".`;
            const explanation = await callGeminiAPI(prompt);
            explanationEl.innerHTML = `<p class="mt-2 p-3 bg-emerald-50 rounded-md border border-emerald-200 text-emerald-800 text-sm">✨ Explanation: ${explanation}</p>`;
        }


        function normalizeAnswer(answer) {
            if (typeof answer !== 'string') return answer;
            return answer.toLowerCase().replace(/\s+/g, '').replace(/\$|,/g, '');
        }
        
        function renderChallenge(challengeId) {
            currentChallengeId = challengeId;
            const challenge = questData[challengeId];

            challengeTitle.textContent = challenge.title;
            challengeDescription.textContent = challenge.description;
            contentContainer.innerHTML = '';

            challenge.questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'p-5 border border-slate-200 rounded-xl bg-slate-50';
                questionEl.id = `question-${challengeId}-${index}`;

                let inputHtml = `<p class="mb-3 font-semibold text-slate-700">${index + 1}. ${q.text}</p>`;
                switch (q.type) {
                    case 'text':
                        inputHtml += `<input type="text" id="answer-${challengeId}-${index}" class="mt-1 block w-full md:w-1/2 rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500">`;
                        break;
                    case 'mcq':
                        const optionsHtml = q.options.map((opt, i) => `
                            <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-slate-100 cursor-pointer">
                                <input type="radio" name="answer-${challengeId}-${index}" value="${i}" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-slate-300">
                                <span class="text-slate-700">${opt}</span>
                            </label>`).join('');
                        inputHtml += `<div class="mt-2 space-y-1">${optionsHtml}</div>`;
                        break;
                    case 'truefalse':
                        inputHtml += `<div class="mt-2 space-x-4">
                                         <label class="p-2 rounded-md hover:bg-slate-100 cursor-pointer"><input type="radio" name="answer-${challengeId}-${index}" value="true" class="mr-2"> True</label>
                                         <label class="p-2 rounded-md hover:bg-slate-100 cursor-pointer"><input type="radio" name="answer-${challengeId}-${index}" value="false" class="mr-2"> False</label>
                                     </div>`;
                        break;
                }

                questionEl.innerHTML = `${inputHtml}
                                        <div class="flex flex-wrap gap-2 mt-4">
                                            <button class="check-btn px-5 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 text-sm font-semibold shadow-sm transition-transform hover:scale-105" data-challenge="${challengeId}" data-index="${index}">Check Answer</button>
                                            <button class="hint-btn px-5 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-semibold shadow-sm transition-transform hover:scale-105" data-question-text="${q.text}" data-challenge="${challengeId}" data-index="${index}">Get Hint ✨</button>
                                        </div>
                                        <p class="feedback mt-3 text-sm font-medium"></p>
                                        <div class="gemini-response mt-2"></div>`;
                contentContainer.appendChild(questionEl);
            });
            updateNav();
        }

        function handleCheckAnswer(e) {
            const button = e.target;
            const challengeId = button.dataset.challenge;
            const index = parseInt(button.dataset.index);
            const question = questData[challengeId].questions[index];
            const questionEl = document.getElementById(`question-${challengeId}-${index}`);
            const feedbackEl = questionEl.querySelector('.feedback');
            const inputEl = questionEl.querySelector('input, div');
            const geminiResponseContainer = questionEl.querySelector('.gemini-response');
            
            let userAnswer;
            let isCorrect = false;
            let actualAnswerText = '';

            switch (question.type) {
                case 'text':
                    const textInput = document.getElementById(`answer-${challengeId}-${index}`);
                    userAnswer = textInput.value;
                    isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(question.answer);
                    actualAnswerText = question.answer;
                    break;
                case 'mcq':
                    const selectedRadio = document.querySelector(`input[name="answer-${challengeId}-${index}"]:checked`);
                    userAnswer = selectedRadio ? selectedRadio.value : null;
                    isCorrect = parseInt(userAnswer) === question.answer;
                    actualAnswerText = question.options[question.answer];
                    break;
                case 'truefalse':
                    const selectedTF = document.querySelector(`input[name="answer-${challengeId}-${index}"]:checked`);
                    userAnswer = selectedTF ? selectedTF.value : null;
                    isCorrect = userAnswer === question.answer;
                    actualAnswerText = question.answer;
                    break;
            }

            inputEl.classList.remove('correct-answer', 'incorrect-answer');
            if (isCorrect) {
                performanceScores[challengeId].correct++;
                feedbackEl.textContent = 'Correct! Awesome job!';
                feedbackEl.className = 'feedback mt-3 text-sm font-medium text-emerald-600';
                inputEl.classList.add('correct-answer');
                geminiResponseContainer.innerHTML = ''; // Clear any previous hint
            } else {
                feedbackEl.textContent = `Not quite, try that one again or ask for help!`;
                feedbackEl.className = 'feedback mt-3 text-sm font-medium text-rose-600';
                inputEl.classList.add('incorrect-answer');
                
                // Add Explain Concept button if incorrect
                const explainBtn = document.createElement('button');
                explainBtn.className = 'explain-btn mt-2 px-5 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 text-sm font-semibold shadow-sm transition-transform hover:scale-105';
                explainBtn.textContent = 'Explain Concept ✨';
                explainBtn.dataset.questionText = question.text;
                explainBtn.dataset.correctAnswer = actualAnswerText;
                geminiResponseContainer.innerHTML = ''; // Clear previous hint if any
                geminiResponseContainer.appendChild(explainBtn);
            }
            
            button.disabled = true;
            button.style.opacity = '0.6';
            questionEl.querySelector('.hint-btn').disabled = true; // Disable hint after checking
            questionEl.querySelector('.hint-btn').style.opacity = '0.6';
            updateChart();
        }

        function updateNav() {
            document.querySelectorAll('#challenges-nav .nav-button').forEach(btn => {
                btn.setAttribute('aria-current', btn.dataset.challenge === currentChallengeId);
            });
        }
        
        function initNav() {
            Object.keys(questData).forEach(challengeId => {
                const button = document.createElement('button');
                button.textContent = questData[challengeId].title;
                button.className = 'nav-button flex-1 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-all duration-200';
                button.dataset.challenge = challengeId;
                button.onclick = () => renderChallenge(challengeId);
                navContainer.appendChild(button);
            });
        }
        
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(questData).map(c => c.title),
                    datasets: [{
                        label: 'Correct Answers',
                        data: [0, 0, 0],
                        backgroundColor: ['rgba(56, 189, 248, 0.6)', 'rgba(34, 197, 94, 0.6)', 'rgba(244, 63, 94, 0.6)'],
                        borderColor: ['#0ea5e9', '#16a34a', '#e11d48'],
                        borderWidth: 2,
                        borderRadius: 5,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 7, 
                            ticks: {
                                stepSize: 1,
                                color: '#475569'
                            },
                             grid: {
                                display: false
                            }
                        },
                        y: {
                             grid: {
                                display: false
                            },
                             ticks: {
                                color: '#334155'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.x !== null) {
                                        const total = performanceScores[Object.keys(performanceScores)[context.dataIndex]].total;
                                        label += `${context.parsed.x} out of ${total}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            const scores = Object.values(performanceScores).map(s => s.correct);
            performanceChart.data.datasets[0].data = scores;
            
            //Dynamically set max value of chart based on questions per section
            const maxScores = Object.values(performanceScores).map(s => s.total);
            performanceChart.options.scales.x.max = Math.max(...maxScores, 5);

            performanceChart.update();

            const totalCorrect = Object.values(performanceScores).reduce((sum, s) => sum + s.correct, 0);
            const totalAnswered = document.querySelectorAll('.check-btn:disabled').length;
            const totalQuestions = Object.values(questData.understanding.questions).length + Object.values(questData.working.questions).length + Object.values(questData.scaling.questions).length;

            if (totalAnswered > 0) {
                 document.getElementById('summary-text').textContent = `Total Score: ${totalCorrect} / ${totalAnswered}`
            }
             if (totalAnswered === totalQuestions) {
                 document.getElementById('summary-text').textContent += ` - Quest Complete!`
             }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initNav();
            initChart();
            renderChallenge('understanding');

            contentContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('check-btn')) {
                    handleCheckAnswer(e);
                } else if (e.target.classList.contains('hint-btn')) {
                    const questionText = e.target.dataset.questionText;
                    const geminiResponseContainer = e.target.closest('.p-5').querySelector('.gemini-response');
                    getGeminiHint(questionText, geminiResponseContainer);
                } else if (e.target.classList.contains('explain-btn')) {
                    const questionText = e.target.dataset.questionText;
                    const correctAnswer = e.target.dataset.correctAnswer;
                    const geminiResponseContainer = e.target.closest('.p-5').querySelector('.gemini-response');
                    getGeminiExplanation(questionText, correctAnswer, geminiResponseContainer);
                }
            });
        });

    </script>
</body>
</html>
